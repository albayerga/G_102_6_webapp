{% extends "base.html" %}
{% block page_title %}Dashboard{% endblock %}

{% block header %}
    <!-- Carga de Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.6.2/chart.min.js"
            integrity="sha512-tMabqarPtykgDtdtSqCL3uLVM0gS1ZkUAVhRFu1vSEFgvB73niFQWJuvviDyBGBH22Lcau4rHB5p2K2T0Xvr6Q=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
{% endblock %}

{% block content %}

    <h2>General stadistics</h2>
    <ul>
        <li><strong>Total queries made:</strong> {{ query_stats }}</li>
        <li><strong>Total unique visitors:</strong> {{ visitor_stats }}</li>
        <li><strong>Total clicks on documents:</strong> {{ click_stats }}</li>
        <li><strong>Total active sessions:</strong> {{ session_stats }}</li>
        <li><strong>Average dwell time (in seconds):</strong> {{ avg_dwell_time | round(2) }}</li>
    </ul>
    <hr>

    <h3>Graphics</h3>
    <div style="display: flex; justify-content: space-around;">
        <!-- Gráfico de clics por documento -->
        <div>
            <h4>Clicks per document</h4>
            <p style="color: gray; font-size: 0.9em;">This shows the popularity of documents based on user interaction</p>
            <canvas id="clicksByDocChart" width="400" height="400"></canvas>
        </div>
        <!-- Gráfico de sesiones por consultas -->
        <div>
            <h4>Queries per session</h4>
            <p style="color: gray; font-size: 0.9em;">This shows the number of queries made during each user session</p>
            <canvas id="queriesBySessionChart" width="400" height="400"></canvas>
        </div>
    </div>
    <hr>

    <script>
        // Clics por documento
        const clicksByDoc = {{ clicks_by_doc | tojson | safe }};
        const docLabels = clicksByDoc.map(doc => "Doc: " + doc.doc_id);
        const docClicks = clicksByDoc.map(doc => doc.clicks);

        const clicksByDocChart = new Chart(
            document.getElementById('clicksByDocChart').getContext('2d'),
            {
                type: 'bar',
                data: {
                    labels: docLabels,
                    datasets: [{
                        label: 'Clicks per document',
                        data: docClicks,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } }
                }
            }
        );

        // Consultas por sesión
        fetch('/api/sessions')
            .then(response => response.json())
            .then(data => {
                const sessionLabels = data.map(session => session.session_id);
                const queriesPerSession = data.map(session => session.queries);

                new Chart(
                    document.getElementById('queriesBySessionChart').getContext('2d'),
                    {
                        type: 'line',
                        data: {
                            labels: sessionLabels,
                            datasets: [{
                                label: 'Queries per session',
                                data: queriesPerSession,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: { y: { beginAtZero: true } }
                        }
                    }
                );
            });
    </script>

    <script>
        // 'visited_docs' is the data coming from Python code.
        // load the python list in the JS variable 'visits_list':
        const visits_list = {{ visited_docs | tojson | safe }};
        console.log("visited docs: ")
        console.log(visits_list)
    </script>

    <h5>Ranking of Visited Documents</h5>
    <canvas id="dailyVisits" width="400" height="400"></canvas>


    <script>
        // use JS map function top get just the tweet ids as labels
        const visitsLabels = visits_list.map(a => "id: " + a.doc_id);
        const visitsData = visits_list.map(a => a.counter);
        const chartData1 = {
            labels: visitsLabels,
            datasets: [{
                label: 'Visits count',
                // data: [65, 59, 80, 81, 56, 55, 40],
                data: visitsData,
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        };

        const ctx = document.getElementById('dailyVisits').getContext('2d');

        // This will render the chart
        const myChart = new Chart(ctx, {
            type: 'line',
            data: chartData1,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

    </script>

    <!-- <h3>Visited documents details</h3>
    <table>
        <thead>
            <tr>
                <th>Document ID</th>
                <th>Description</th>
                <th>Number of clicks</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in visited_docs %}
            <tr>
                <td>{{ doc.doc_id }}</td>
                <td>{{ doc.description }}</td>
                <td>{{ doc.counter }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table> -->
    
    <!-- <p style="margin-top: 10px; color: gray; font-size: 0.9em;">
        For more details, see the <a href="stats" style="color: #007bff; text-decoration: none;">Stats page</a>.
    </p> -->
    <div class="card-footer text-center">
        <!-- <a href="#" class="btn btn-secondary" onclick="history.go(-2)">Go Back</a> -->
        <a href="/stats" class="btn btn-info">View Stats</a>
        <a href="/" class="btn btn-success">Go back</a>
    </div>

{% endblock %}

    



